<!DOCTYPE html>
<html lang="jp" style="height:100%;width:100%">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>One Remote Controller</title>
    <!--Import Google Icon Fontã€€ã“ã‚Œ httpsã«ã™ã‚‹ã¨å‹•ã-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
</head>

<body>

    <!-- Card -->
    <div class="container" style="max-width: 100%;height: auto;">
        <div class="">
            <div class="col s12 m5">
                <div class="card-panel green">
                    <span class="white-text">
                        <h3>One Remote Controller</h3>
                        <br>
                        <p>Raspberry Piã§å®¶é›»æ“ä½œã§ãã¾ã™ã€‚</p>
                        <br>

                        <a class="waves-effect waves-light btn" onclick="connectionWebSocket()"><i
                                class="material-icons left">power</i>èµ·å‹•</a>
                        <a class="waves-effect waves-light btn" onclick="closeWebSocket()"><i
                                class="material-icons left">close</i>çµ‚äº†</a>
                        <a class="waves-effect waves-light btn" onclick="sendRemoteControll('light_off')"><i
                                class="material-icons left">highlight</i>ç…§æ˜OFFãƒ†ã‚¹ãƒˆ</a>

                        <p>Mastodonã®è¨­å®šã€‚é€ä¿¡ã€å—ä¿¡ã¨ã‚‚ã«åŒã˜Mastodonã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                            <br>
                            å—ä¿¡ç”¨ã€é€ä¿¡ç”¨åŒã˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ§‹ã„ã¾ã›ã‚“ã€‚
                        </p>
                        <div class="input-field col s12">
                            <input placeholder="Mastodonã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å" value="" id="mastodon_instance" type="text"
                                class="validate">
                            <input placeholder="ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³" value="" id="mastodon_access_token" type="password"
                                class="validate">
                            <input placeholder="Mastodonã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ID" value="" id="mastodon_account_id" type="text"
                                class="validate">
                        </div>
                        <br>
                    </span>
                </div>
            </div>
        </div>
    </div>
</body>

<script>

    //èµ·å‹•æ™‚ã«èª­ã¿è¾¼ã‚€
    window.onload = function (e) {
        document.getElementById('mastodon_instance').value = localStorage.getItem('instance');
        document.getElementById('mastodon_access_token').value = localStorage.getItem('access_token');
        document.getElementById('mastodon_account_id').value = localStorage.getItem('account_id');
    }

    var webSocket;

    function connectionWebSocket() {
        //å¿…è¦ãªã‚‚ã®
        var mastodon_instance = document.getElementById('mastodon_instance').value;
        var mastodon_access_token = document.getElementById('mastodon_access_token').value;
        var account_id = document.getElementById('mastodon_account_id').value;
        //WebSocketæ¥ç¶š
        //ä»Šå›ã¯WebSocketã®ãƒªãƒ³ã‚¯ã‚’æ¨™æº–ã«ã—ã¦ã¾ã™ãŒã€ä¸€éƒ¨ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã¯ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°APIç”¨ã«åˆ¥ã®ãƒªãƒ³ã‚¯ãŒè¨­å®šã•ã‚Œã¦ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
        // ãã®æ™‚ã¯ api/v1/instance ã‚’å©ã„ã¦ urls ã® streaming_api ã®å€¤ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚
        var websocketUri = `wss://${mastodon_instance}/api/v1/streaming/?stream=direct&access_token=${mastodon_access_token}`
        webSocket = new WebSocket(websocketUri);

        //ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åã‚’ä¿å­˜ã™ã‚‹
        localStorage.setItem('instance', mastodon_instance);
        localStorage.setItem('access_token', mastodon_access_token);
        localStorage.setItem('account_id', account_id);
        // æ¥ç¶šã‚’é–‹ã
        webSocket.addEventListener('open', function (event) {
            alert('æ¥ç¶šã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚')
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¾…ã¡å—ã‘ã‚‹
        webSocket.addEventListener('message', function (event) {
            //JSONãƒ‘ãƒ¼ã‚¹
            var obj = JSON.parse(event.data)
            //ä¸€åº¦æ–‡å­—åˆ—ã«ã™ã‚‹
            var payload = obj.payload
            var payloadObject = JSON.parse(payload)

            //å†…å®¹ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
            var content = payloadObject.last_status.content
            var id = payloadObject.last_status.account.id

            //æ¯”è¼ƒ
            //ãŸã ã—ã€è‡ªåˆ†ã®IDã ã¨è¿”ä¿¡ã®ã¨ãã‚‚åå¿œã—ã¦ã—ã¾ã†ã®ã§ON/OFFãŒã‚ã£ãŸã¨ãã ã‘å®Ÿè¡Œ
            if (content.match('OFF') || content.match('ON')) {
                if (id == account_id) {
                    //åŒã˜ã ã£ãŸã‚‰å†…å®¹å–å¾—
                    //é¢å€’ãªã®ã§ã€ç…§æ˜ã€ã‚¨ã‚¢ã‚³ãƒ³ã®æ–‡å­—ãŒã‚ã£ã¦ã€ONã€OFFãŒã‚ã‚Œã°ã„ã„ã¨ã—ã¾ã™ã€‚
                    if (content.match('ç…§æ˜')) {
                        if (content.match('ON')) {
                            sendRemoteControll('light_on')
                        } else {
                            sendRemoteControll('light_off')
                        }
                    } else if (content.match('ã‚¨ã‚¢ã‚³ãƒ³')) {
                        if (content.match('ON')) {
                            sendRemoteControll('air_on')
                        } else {
                            sendRemoteControll('air_off')
                        }
                    } else if (content.match('æ‰‡é¢¨æ©Ÿ')) {
                        if (content.match('ON')) {
                            sendRemoteControll('fan_on')
                        } else {
                            sendRemoteControll('fan_off')
                        }
                    }
                }
            }
        });
    }

    function closeWebSocket() {
        webSocket.close()
    }

    //èµ¤å¤–ç·šé€ä¿¡
    //commandName light_on light_off air_on air_off fan_on fan_off
    function sendRemoteControll(name) {
        //ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã€‚ã“ã‚Œã§èµ¤å¤–ç·šé€ä¿¡ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›
        const exec = require('child_process').exec;
        //cdã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç§»å‹•ã—ã¦ã‹ã‚‰èµ¤å¤–ç·šé€ä¿¡ã‚³ãƒãƒ³ãƒ‰ã‚’ã„ã‚Œã‚‹
        var command = `cd /home/pi/ ; python3 irrp.py -p -g17 -f codes ${name}`;
        exec(command, (err, stdout, stderr) => {
            if (err) {
                postStatus(`èµ¤å¤–ç·šã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸãƒ»ãƒ»ãƒ»ğŸ˜¥ : ${err}`);
            } else {
                postStatus('èµ¤å¤–ç·šé€ä¿¡ã§ãã¾ã—ãŸï¼ğŸ¥³');
            }
        });
    }

    //Mastodonã«æŠ•ç¨¿
    //ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§é€ä¿¡ã—ã¾ã™
    function postStatus(status) {
        //å¿…è¦ãªã‚‚ã®
        var mastodon_instance = document.getElementById('mastodon_instance').value;
        var mastodon_access_token = document.getElementById('mastodon_access_token').value;
        var xmlHttpRequest = new XMLHttpRequest();
        xmlHttpRequest.addEventListener("load", function (event) {

        }, false);
        xmlHttpRequest.responseType = "json";
        xmlHttpRequest.open("POST", `https://${mastodon_instance}/api/v1/statuses?access_token=${mastodon_access_token}`);
        xmlHttpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
        xmlHttpRequest.send("status=" + encodeURIComponent(status) + "&visibility=direct");
    }

</script>

</html>